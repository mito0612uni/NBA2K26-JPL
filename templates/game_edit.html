{% extends "layout.html" %}

{% block content %}
<style>
  /* このページ専用の簡単なスタイル */
  .bench { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
  .bench-player { background-color: #f0f0f0; border: 1px solid #ccc; padding: 5px 10px; border-radius: 15px; cursor: pointer; display: inline-block; margin: 5px; }
  .bench-player:hover { background-color: #e0e0e0; }
  .bench-player.selected { background-color: #a0a0a0; color: white; cursor: not-allowed; }
  .stats-table input { width: 40px; }
  #ocr-feedback { margin-top: 10px; font-weight: bold; }
</style>

<h2>
  {% if current_user.is_authenticated %}結果入力{% else %}試合スタッツ{% endif %}: 
  {{ game.home_team.name }} vs {{ game.away_team.name }}
</h2>

<p style="margin-bottom: 15px;">
  チーム得点は自動計算されます。
  {% if current_user.is_authenticated %}
  ベンチから5名選んでスタッツを入力してください。
  {% else %}
  これは閲覧専用です。結果を編集するには<a href="{{ url_for('login') }}">ログイン</a>してください。
  {% endif %}
</p>

{% if current_user.is_authenticated and current_user.is_admin %}
<div style="border: 2px dashed #007bff; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
  <h4>OCR自動入力 (試験機能)</h4>
  <p>試合結果のスクリーンショット画像をアップロードしてください。</p>
  <input type="file" id="ocr-image-input" accept="image/*">
  <button type="button" id="ocr-submit-btn">画像から読み込む</button>
  <div id="ocr-feedback"></div>
</div>
{% endif %}

{# ... (不戦勝処理やスタッツ入力フォームは変更なし) ... #}
<form method="post">
  </form>

{% endblock %}


{# ★★★ ここからが修正部分です。すべてのJavaScriptをこの中にまとめます ★★★ #}
{% block scripts %}
<script>
// データベースから渡された既存のスタッツをJSON形式で受け取る
const existingStats = {{ stats | tojson }};

document.addEventListener('DOMContentLoaded', function() {
  const statHeaders = ['選手名', '得点', 'ｱｼｽﾄ', 'ﾘﾊﾞｳﾝﾄﾞ', 'ｽﾃｨｰﾙ', 'ﾌﾞﾛｯｸ', 'ﾌｧｳﾙ', 'TO', 'FGM', 'FGA', '3PM', '3PA', 'FTM', 'FTA'];
  const statFields = ['player_name', 'pts', 'ast', 'reb', 'stl', 'blk', 'foul', 'turnover', 'fgm', 'fga', 'three_pm', 'three_pa', 'ftm', 'fta'];
  const isUserAuthenticated = {{ current_user.is_authenticated | tojson }};

  function createHeaderRow() {
    return '<tr>' + statHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
  }

  function createPlayerRow(playerId, playerName, teamId) {
    const playerStats = existingStats[playerId] || {};
    let rowHTML = `<td>${playerName}</td>`;
    statFields.slice(1).forEach(field => {
      const value = playerStats[field] || 0;
      const readonly = isUserAuthenticated ? '' : 'readonly';
      rowHTML += `<td><input type="number" name="player_${playerId}_${field}" value="${value}" min="0" ${readonly}></td>`;
    });
    return `<tr data-player-id="${playerId}" data-team-id="${teamId}">${rowHTML}</tr>`;
  }
  
  function populateInitialStats() {
    const statsHeaderHome = document.getElementById('stats-header-home');
    const statsBodyHome = document.getElementById('stats-body-home');
    const statsHeaderAway = document.getElementById('stats-header-away');
    const statsBodyAway = document.getElementById('stats-body-away');

    let homeHasStats = false;
    let awayHasStats = false;

    for (const playerId in existingStats) {
      const player = document.querySelector(`.bench-player[data-player-id='${playerId}']`);
      if (player) {
        const teamId = player.dataset.teamId;
        const playerName = player.dataset.playerName;
        if (teamId === 'home') {
          statsBodyHome.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
          if (isUserAuthenticated) player.classList.add('selected'); 
          homeHasStats = true;
        } else if (teamId === 'away') {
          statsBodyAway.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
          if (isUserAuthenticated) player.classList.add('selected');
          awayHasStats = true;
        }
      }
    }
    
    if (homeHasStats) statsHeaderHome.innerHTML = createHeaderRow();
    if (awayHasStats) statsHeaderAway.innerHTML = createHeaderRow();
  }

  populateInitialStats();

  if (isUserAuthenticated) {
    document.querySelectorAll('.bench-player').forEach(playerSpan => {
      playerSpan.addEventListener('click', function() {
        if (this.classList.contains('selected')) return;
        const teamId = this.dataset.teamId;
        const statsBody = document.getElementById(`stats-body-${teamId}`);
        if (statsBody.children.length >= 5) {
          alert('選択できる選手は5人までです。');
          return;
        }
        const statsHeader = document.getElementById(`stats-header-${teamId}`);
        if (statsHeader.children.length === 0) statsHeader.innerHTML = createHeaderRow();
        const playerId = this.dataset.playerId;
        const playerName = this.dataset.playerName;
        statsBody.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
        this.classList.add('selected');
      });
    });

    document.querySelectorAll('.reset-btn').forEach(button => {
      button.addEventListener('click', function() {
        const teamId = this.dataset.teamId;
        document.getElementById(`stats-header-${teamId}`).innerHTML = '';
        document.getElementById(`stats-body-${teamId}`).innerHTML = '';
        document.querySelectorAll(`#bench-${teamId} .bench-player`).forEach(span => {
          span.classList.remove('selected');
        });
      });
    });

    // --- OCRボタンの処理 ---
    const ocrBtn = document.getElementById('ocr-submit-btn');
    if (ocrBtn) {
        ocrBtn.addEventListener('click', function() {
            const imageInput = document.getElementById('ocr-image-input');
            const feedbackDiv = document.getElementById('ocr-feedback');
            
            if (imageInput.files.length === 0) {
                feedbackDiv.textContent = '画像ファイルを選択してください。';
                feedbackDiv.style.color = 'red';
                return;
            }

            feedbackDiv.textContent = '画像をアップロードして解析中...';
            feedbackDiv.style.color = 'blue';

            const formData = new FormData();
            formData.append('image', imageInput.files[0]);

            fetch("{{ url_for('ocr_upload') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    feedbackDiv.textContent = `エラー: ${data.error}`;
                    feedbackDiv.style.color = 'red';
                    return;
                }

                let playersFound = 0;
                for (const playerName in data) {
                    const playerSpan = [...document.querySelectorAll('.bench-player')].find(span => span.dataset.playerName === playerName);
                    
                    if (playerSpan) {
                        playersFound++;
                        if (!playerSpan.classList.contains('selected')) {
                            playerSpan.click();
                        }
                        
                        setTimeout(() => {
                            const stats = data[playerName];
                            const playerId = playerSpan.dataset.playerId;
                            for (const statName in stats) {
                                const input = document.querySelector(`input[name='player_${playerId}_${statName}']`);
                                if (input) {
                                    input.value = stats[statName];
                                }
                            }
                        }, 100); 
                    }
                }
                feedbackDiv.textContent = `${Object.keys(data).length}人のプレイヤーデータを検出し、${playersFound}人の登録済みプレイヤーに反映しました。`;
                feedbackDiv.style.color = 'green';
            })
            .catch(error => {
                feedbackDiv.textContent = `通信エラーが発生しました: ${error}`;
                feedbackDiv.style.color = 'red';
            });
        });
    }
  }
});
</script>
{% endblock %}