{% extends "layout.html" %}
{% block content %}
<style>
  /* スタイルは変更なし */
  .bench { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
  .bench-player { background-color: #f0f0f0; border: 1px solid #ccc; padding: 5px 10px; border-radius: 15px; cursor: pointer; display: inline-block; margin: 5px; }
  .bench-player:hover { background-color: #e0e0e0; }
  .bench-player.selected { background-color: #a0a0a0; color: white; cursor: not-allowed; }
  .stats-table input { width: 40px; }
  #ocr-feedback { margin-top: 10px; font-weight: bold; }
</style>

<h2>結果入力...</h2>
<p>...</p>
{% if current_user.is_authenticated and current_user.is_admin %}
{% endif %}
<form method="post">
  </form>
{% endblock %}


{% block scripts %}
<script>
const existingStats = {{ stats | tojson }};

document.addEventListener('DOMContentLoaded', function() {
  const statHeaders = ['選手名', '得点', 'ｱｼｽﾄ', 'ﾘﾊﾞｳﾝﾄﾞ', 'ｽﾃｨｰﾙ', 'ﾌﾞﾛｯｸ', 'ﾌｧｳﾙ', 'TO', 'FGM', 'FGA', '3PM', '3PA', 'FTM', 'FTA'];
  const statFields = ['player_name', 'pts', 'ast', 'reb', 'stl', 'blk', 'foul', 'turnover', 'fgm', 'fga', 'three_pm', 'three_pa', 'ftm', 'fta'];
  const isUserAuthenticated = {{ current_user.is_authenticated | tojson }};

  function createHeaderRow() {
    return '<tr>' + statHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
  }

  // ★★★ ここからが修正点1 ★★★
  // 作成されるテーブルの行に、プレイヤー名を直接保存するようにする
  function createPlayerRow(playerId, playerName, teamId) {
    const playerStats = existingStats[String(playerId)] || {};
    let rowHTML = `<td>${playerName}</td>`;
    statFields.slice(1).forEach(field => {
      const value = playerStats[field] || 0;
      const readonly = isUserAuthenticated ? '' : 'readonly';
      rowHTML += `<td><input type="number" name="player_${playerId}_${field}" value="${value}" min="0" ${readonly}></td>`;
    });
    // data-player-name 属性を追加
    return `<tr data-player-id="${playerId}" data-player-name="${playerName}" data-team-id="${teamId}">${rowHTML}</tr>`;
  }
  
  function populateInitialStats() {
    // (この関数の中身は変更なし)
  }

  populateInitialStats();

  if (isUserAuthenticated) {
    // --- 手動入力の処理 (変更なし) ---
    document.querySelectorAll('.bench-player').forEach(playerSpan => {
        // ...
    });
    document.querySelectorAll('.reset-btn').forEach(button => {
        // ...
    });

    // --- OCRボタンの処理 ---
    const ocrBtn = document.getElementById('ocr-submit-btn');
    if (ocrBtn) {
        ocrBtn.addEventListener('click', function() {
            const imageInput = document.getElementById('ocr-image-input');
            const feedbackDiv = document.getElementById('ocr-feedback');
            const formData = new FormData();
            
            // ★★★ ここからが修正点2 ★★★
            // 選択済みのテーブル行から直接プレイヤー名を取得するように修正
            const selectedPlayerRows = document.querySelectorAll('#stats-body-home tr, #stats-body-away tr');
            if (selectedPlayerRows.length === 0) {
                feedbackDiv.textContent = 'エラー: 先に出場選手をベンチから選択してください。';
                feedbackDiv.style.color = 'red';
                return;
            }
            selectedPlayerRows.forEach(row => {
                // rowに保存された data-player-name を直接使う
                formData.append('selected_players[]', row.dataset.playerName);
            });
            
            if (imageInput.files.length === 0) {
                feedbackDiv.textContent = '画像ファイルを選択してください。';
                feedbackDiv.style.color = 'red';
                return;
            }
            formData.append('image', imageInput.files[0]);

            feedbackDiv.textContent = '画像をアップロードして解析中...';
            feedbackDiv.style.color = 'blue';

            fetch("{{ url_for('ocr_upload') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // (これ以降のデータ反映ロジックは変更なし)
            })
            .catch(error => {
                feedbackDiv.textContent = `通信エラーが発生しました: ${error}`;
                feedbackDiv.style.color = 'red';
            });
        });
    }
  }
});
</script>
{% endblock %}