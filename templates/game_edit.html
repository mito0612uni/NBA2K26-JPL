{% extends "layout.html" %}

{% block content %}
<style>
  /* このページ専用の簡単なスタイル */
  .bench { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
  .bench-player { background-color: #f0f0f0; border: 1px solid #ccc; padding: 5px 10px; border-radius: 15px; cursor: pointer; display: inline-block; margin: 5px; }
  .bench-player:hover { background-color: #e0e0e0; }
  .bench-player.selected { background-color: #a0a0a0; color: white; cursor: not-allowed; }
  .stats-table input { width: 40px; }
</style>

<h2>
  {% if current_user.is_authenticated %}結果入力{% else %}試合スタッツ{% endif %}: 
  {{ game.home_team.name }} vs {{ game.away_team.name }}
</h2>

{# ★★★ 新しい説明文を追加 ★★★ #}
<p style="margin-bottom: 15px;">
  チーム得点は自動計算されます。
  {% if current_user.is_authenticated %}
  ベンチから5名選んでスタッツを入力してください。
  {% else %}
  これは閲覧専用です。結果を編集するには<a href="{{ url_for('login') }}">ログイン</a>してください。
  {% endif %}
</p>
{# ★★★ 管理者向けアクションを追加 ★★★ #}
{% if current_user.is_authenticated and current_user.is_admin %}
<div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h4>管理者アクション：不戦勝処理</h4>
    <p>以下のボタンを押すと、スタッツを入力せずに不戦勝として即座に結果を記録します（スコアは0-0になります）。</p>
    <div style="display: flex; gap: 20px;">
        <form action="{{ url_for('forfeit_game', game_id=game.id) }}" method="post" onsubmit="return confirm('{{ game.home_team.name }} の不戦勝として記録しますか？');">
            <input type="hidden" name="winning_team_id" value="{{ game.home_team_id }}">
            <button type="submit" style="background-color: #28a745; color: white;">{{ game.home_team.name }} の不戦勝</button>
        </form>
        <form action="{{ url_for('forfeit_game', game_id=game.id) }}" method="post" onsubmit="return confirm('{{ game.away_team.name }} の不戦勝として記録しますか？');">
            <input type="hidden" name="winning_team_id" value="{{ game.away_team_id }}">
            <button type="submit" style="background-color: #28a745; color: white;">{{ game.away_team.name }} の不戦勝</button>
        </form>
    </div>
</div>
{% endif %}
<form method="post">
  {# --- ホームチーム --- #}
  <div class="team-section">
    <h3>{{ game.home_team.name }}</h3>
    {% if current_user.is_authenticated %}
    <div class="bench" id="bench-home">
      <strong>ベンチ:</strong>
      {% for player in game.home_team.players %}
        <span class="bench-player" data-team-id="home" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">{{ player.name }}</span>
      {% endfor %}
    </div>
    {% endif %}
    <table class="stats-table">
      <thead id="stats-header-home"></thead>
      <tbody id="stats-body-home"></tbody>
    </table>
    {% if current_user.is_authenticated %}
    <button type="button" class="reset-btn" data-team-id="home">選択をリセット</button>
    {% endif %}
  </div>

  <hr style="margin: 30px 0;">

  {# --- アウェイチーム --- #}
  <div class="team-section">
    <h3>{{ game.away_team.name }}</h3>
    {% if current_user.is_authenticated %}
    <div class="bench" id="bench-away">
      <strong>ベンチ:</strong>
      {% for player in game.away_team.players %}
        <span class="bench-player" data-team-id="away" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">{{ player.name }}</span>
      {% endfor %}
    </div>
    {% endif %}
    <table class="stats-table">
      <thead id="stats-header-away"></thead>
      <tbody id="stats-body-away"></tbody>
    </table>
    {% if current_user.is_authenticated %}
    <button type="button" class="reset-btn" data-team-id="away">選択をリセット</button>
    {% endif %}
  </div>

  <hr style="margin: 30px 0;">

  {# ★★★ YouTube入力欄を2つに修正 ★★★ #}
  {% if current_user.is_authenticated %}
  <div>
    <h3>試合の動画リンク</h3>
    <div style="margin-bottom: 10px;">
      <label for="youtube_url_home">{{ game.home_team.name }}側 URL:</label>
      <input type="url" id="youtube_url_home" name="youtube_url_home" value="{{ game.youtube_url_home or '' }}" placeholder="https://..." style="width: 100%; max-width: 500px; padding: 5px;">
    </div>
    <div>
      <label for="youtube_url_away">{{ game.away_team.name }}側 URL:</label>
      <input type="url" id="youtube_url_away" name="youtube_url_away" value="{{ game.youtube_url_away or '' }}" placeholder="https://..." style="width: 100%; max-width: 500px; padding: 5px;">
    </div>
  </div>
  {% endif %}
  
  {% if current_user.is_authenticated %}
  <button type="submit" style="margin-top: 20px; padding: 10px 20px; font-size: 16px;">結果を保存</button>
  {% endif %}
</form>

<script>
// ★★★ データベースから渡された既存のスタッツをJSON形式で受け取る ★★★
const existingStats = {{ stats | tojson }};

document.addEventListener('DOMContentLoaded', function() {
  const statHeaders = ['選手名', '得点', 'ｱｼｽﾄ', 'ﾘﾊﾞｳﾝﾄﾞ', 'ｽﾃｨｰﾙ', 'ﾌﾞﾛｯｸ', 'ﾌｧｳﾙ', 'TO', 'FGM', 'FGA', '3PM', '3PA', 'FTM', 'FTA'];
  const statFields = ['player_name', 'pts', 'ast', 'reb', 'stl', 'blk', 'foul', 'turnover', 'fgm', 'fga', 'three_pm', 'three_pa', 'ftm', 'fta'];
  const isUserAuthenticated = {{ current_user.is_authenticated | tojson }};

  // ヘッダー行を生成する関数
  function createHeaderRow() {
    return '<tr>' + statHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
  }

  // 既存のスタッツをvalueに設定するよう修正
  function createPlayerRow(playerId, playerName, teamId) {
    const playerStats = existingStats[playerId] || {};
    let rowHTML = `<td>${playerName}</td>`;
    
    statFields.slice(1).forEach(field => {
      const value = playerStats[field] || 0;
      // ログインしていない場合は入力欄を無効化(readonly)する
      const readonly = isUserAuthenticated ? '' : 'readonly';
      rowHTML += `<td><input type="number" name="player_${playerId}_${field}" value="${value}" min="0" ${readonly}></td>`;
    });
    return `<tr data-player-id="${playerId}" data-team-id="${teamId}">${rowHTML}</tr>`;
  }
  
  // ページ読み込み時に既存のスタッツを表示する関数
  function populateInitialStats() {
    const statsHeaderHome = document.getElementById('stats-header-home');
    const statsBodyHome = document.getElementById('stats-body-home');
    const statsHeaderAway = document.getElementById('stats-header-away');
    const statsBodyAway = document.getElementById('stats-body-away');

    let homeHasStats = false;
    let awayHasStats = false;

    // 既存のスタッツを持つ選手をテーブルに追加
    for (const playerId in existingStats) {
      const player = document.querySelector(`.bench-player[data-player-id='${playerId}']`);
      if (player) {
        const teamId = player.dataset.teamId;
        const playerName = player.dataset.playerName;
        if (teamId === 'home') {
          statsBodyHome.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
          // ベンチの選手を選択済みにする (ログイン時のみ)
          if (isUserAuthenticated) player.classList.add('selected'); 
          homeHasStats = true;
        } else if (teamId === 'away') {
          statsBodyAway.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
          // ベンチの選手を選択済みにする (ログイン時のみ)
          if (isUserAuthenticated) player.classList.add('selected');
          awayHasStats = true;
        }
      } else {
          // 既存のスタッツがあるが、ベンチ選手リストにいない場合（例：選手が削除された後など）
          // 閲覧専用であれば表示は続ける
          const teamId = existingStats[playerId].team_id_from_db; // app.pyからチームIDも渡す必要あり
          const playerName = existingStats[playerId].player_name_from_db; // app.pyから選手名も渡す必要あり
          // この部分は、app.pyのstats辞書にもプレイヤー名とチームIDを含める必要があります
          // 現在のapp.pyのstats辞書はスタッツデータのみなので、playerNameなどを取得できません
          // 暫定的に、ベンチにいない選手は表示しないか、別途処理が必要です。
          // シンプルにするため、ここではベンチにいる選手のみ初期表示しています。
      }
    }
    
    // ヘッダーを追加
    if (homeHasStats) statsHeaderHome.innerHTML = createHeaderRow();
    if (awayHasStats) statsHeaderAway.innerHTML = createHeaderRow();
  }

  // ページ読み込み時に実行
  populateInitialStats();

  if (isUserAuthenticated) {
    // クリックイベントの処理 (ログイン時のみ有効)
    document.querySelectorAll('.bench-player').forEach(playerSpan => {
      playerSpan.addEventListener('click', function() {
        if (this.classList.contains('selected')) return;
        const teamId = this.dataset.teamId;
        const statsBody = document.getElementById(`stats-body-${teamId}`);
        if (statsBody.children.length >= 5) {
          alert('選択できる選手は5人までです。');
          return;
        }
        const statsHeader = document.getElementById(`stats-header-${teamId}`);
        if (statsHeader.children.length === 0) statsHeader.innerHTML = createHeaderRow();
        const playerId = this.dataset.playerId;
        const playerName = this.dataset.playerName;
        statsBody.insertAdjacentHTML('beforeend', createPlayerRow(playerId, playerName, teamId));
        this.classList.add('selected');
      });
    });

    // リセットボタンの処理 (ログイン時のみ有効)
    document.querySelectorAll('.reset-btn').forEach(button => {
      button.addEventListener('click', function() {
        const teamId = this.dataset.teamId;
        document.getElementById(`stats-header-${teamId}`).innerHTML = '';
        document.getElementById(`stats-body-${teamId}`).innerHTML = '';
        document.querySelectorAll(`#bench-${teamId} .bench-player`).forEach(span => {
          span.classList.remove('selected');
        });
      });
    });
  }
});
</script>

{% endblock %}