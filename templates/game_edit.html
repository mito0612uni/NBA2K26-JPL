{% extends "layout.html" %}

{% block content %}
<style>
  /* このページ専用の簡単なスタイル */
  .bench { border: 1px solid #ddd; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
  .bench-player { background-color: #f0f0f0; border: 1px solid #ccc; padding: 5px 10px; border-radius: 15px; cursor: pointer; display: inline-block; margin: 5px; }
  .bench-player:hover { background-color: #e0e0e0; }
  .bench-player.selected { background-color: #a0a0a0; color: white; cursor: not-allowed; }
  .stats-table input { width: 40px; }
  #ocr-feedback { margin-top: 10px; font-weight: bold; }
</style>

<h2>
  {% if current_user.is_authenticated %}結果入力{% else %}試合スタッツ{% endif %}: 
  {{ game.home_team.name }} vs {{ game.away_team.name }}
</h2>

<p style="margin-bottom: 15px;">
  チーム得点は自動計算されます。
  {% if current_user.is_authenticated %}
  OCRで自動入力するか、ベンチから5名選んでスタッツを手動入力してください。
  {% else %}
  これは閲覧専用です。結果を編集するには<a href="{{ url_for('login') }}">ログイン</a>してください。
  {% endif %}
</p>

{% if current_user.is_authenticated and current_user.is_admin %}
<div style="border: 2px dashed #007bff; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
  <h4>OCR自動入力 (試験機能)</h4>
  <p>スクリーンショット画像をアップロードしてください。</p>
  <input type="file" id="ocr-image-input" accept="image/*">
  <button type="button" id="ocr-submit-btn">画像から読み込む</button>
  <div id="ocr-feedback"></div>
</div>

<div style="background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h4>管理者アクション：不戦勝処理</h4>
    <p>以下のボタンを押すと、スタッツを入力せずに不戦勝として即座に結果を記録します（スコアは0-0になります）。</p>
    <div style="display: flex; gap: 20px;">
        <form action="{{ url_for('forfeit_game', game_id=game.id) }}" method="post" onsubmit="return confirm('{{ game.home_team.name }} の不戦勝として記録しますか？');">
            <input type="hidden" name="winning_team_id" value="{{ game.home_team_id }}">
            <button type="submit" style="background-color: #28a745; color: white;">{{ game.home_team.name }} の不戦勝</button>
        </form>
        <form action="{{ url_for('forfeit_game', game_id=game.id) }}" method="post" onsubmit="return confirm('{{ game.away_team.name }} の不戦勝として記録しますか？');">
            <input type="hidden" name="winning_team_id" value="{{ game.away_team_id }}">
            <button type="submit" style="background-color: #28a745; color: white;">{{ game.away_team.name }} の不戦勝</button>
        </form>
    </div>
</div>
{% endif %}

<form method="post">
  {# --- ホームチーム --- #}
  <div class="team-section">
    <h3>{{ game.home_team.name }}</h3>
    {% if current_user.is_authenticated %}
    <div class="bench" id="bench-home">
      <strong>ベンチ:</strong>
      {% for player in game.home_team.players %}
        <span class="bench-player" data-team-id="home" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">{{ player.name }}</span>
      {% endfor %}
    </div>
    {% endif %}
    <table class="stats-table">
      <thead id="stats-header-home"></thead>
      <tbody id="stats-body-home"></tbody>
    </table>
    {% if current_user.is_authenticated %}
    <button type="button" class="reset-btn" data-team-id="home">選択をリセット</button>
    {% endif %}
  </div>

  <hr style="margin: 30px 0;">

  {# --- アウェイチーム --- #}
  <div class="team-section">
    <h3>{{ game.away_team.name }}</h3>
    {% if current_user.is_authenticated %}
    <div class="bench" id="bench-away">
      <strong>ベンチ:</strong>
      {% for player in game.away_team.players %}
        <span class="bench-player" data-team-id="away" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">{{ player.name }}</span>
      {% endfor %}
    </div>
    {% endif %}
    <table class="stats-table">
      <thead id="stats-header-away"></thead>
      <tbody id="stats-body-away"></tbody>
    </table>
    {% if current_user.is_authenticated %}
    <button type="button" class="reset-btn" data-team-id="away">選択をリセット</button>
    {% endif %}
  </div>

  <hr style="margin: 30px 0;">

  {% if current_user.is_authenticated %}
  <div>
    <h3>試合の動画リンク</h3>
    <div style="margin-bottom: 10px;">
      <label for="youtube_url_home">{{ game.home_team.name }}側 URL:</label>
      <input type="url" id="youtube_url_home" name="youtube_url_home" value="{{ game.youtube_url_home or '' }}" placeholder="https://..." style="width: 100%; max-width: 500px; padding: 5px;">
    </div>
    <div>
      <label for="youtube_url_away">{{ game.away_team.name }}側 URL:</label>
      <input type="url" id="youtube_url_away" name="youtube_url_away" value="{{ game.youtube_url_away or '' }}" placeholder="https://..." style="width: 100%; max-width: 500px; padding: 5px;">
    </div>
  </div>
  
  <button type="submit" style="margin-top: 20px; padding: 10px 20px; font-size: 16px;">結果を保存</button>
  {% endif %}
</form>
{% endblock %}


{% block scripts %}
<script>
const existingStats = {{ stats | tojson }};

document.addEventListener('DOMContentLoaded', function() {
  // ... (statHeaders, statFields, isUserAuthenticated の定義は変更なし)

  function createHeaderRow() { /* ... */ }
  function createPlayerRow(playerId, playerName, teamId) { /* ... */ }
  function populateInitialStats() { /* ... */ }
  populateInitialStats();

  if (isUserAuthenticated) {
    // --- 手動入力の処理 (変更なし) ---
    // ...

    // ★★★ OCRボタンの処理を刷新 ★★★
    const ocrBtn = document.getElementById('ocr-submit-btn');
    if (ocrBtn) {
        ocrBtn.addEventListener('click', function() {
            const imageInput = document.getElementById('ocr-image-input');
            const feedbackDiv = document.getElementById('ocr-feedback');

            const selectedPlayerRows = document.querySelectorAll('#stats-body-home tr, #stats-body-away tr');
            if (selectedPlayerRows.length === 0) {
                feedbackDiv.textContent = 'エラー: 先に出場選手をベンチから選択してください。';
                feedbackDiv.style.color = 'red';
                return;
            }
            
            if (imageInput.files.length === 0) {
                feedbackDiv.textContent = '画像ファイルを選択してください。';
                feedbackDiv.style.color = 'red';
                return;
            }

            feedbackDiv.textContent = '画像をアップロードして解析中...';
            feedbackDiv.style.color = 'blue';

            const formData = new FormData();
            formData.append('image', imageInput.files[0]);

            fetch("{{ url_for('ocr_upload') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(foundPlayersList => { // サーバーからは名前とスタッツのペアのリストが返ってくる
                if (foundPlayersList.error) {
                    feedbackDiv.textContent = `エラー: ${foundPlayersList.error}`;
                    feedbackDiv.style.color = 'red';
                    return;
                }
                
                let playersMatched = 0;
                
                // ★★★ ここからが新しいロジック ★★★
                // ユーザーが選択した各選手についてループ
                selectedPlayerRows.forEach(row => {
                    const selectedPlayerName = row.dataset.playerName;
                    const playerId = row.dataset.playerId;

                    // OCRが検出したリストの中から、名前が一致（部分一致）するものを探す
                    const foundData = foundPlayersList.find(p => p.name.includes(selectedPlayerName));
                    
                    if (foundData) {
                        playersMatched++;
                        const stats = foundData.stats;
                        for (const statName in stats) {
                            const input = row.querySelector(`input[name='player_${playerId}_${statName}']`);
                            if (input) {
                                input.value = stats[statName];
                            }
                        }
                    }
                });

                feedbackDiv.textContent = `成功: ${playersMatched}人の選手にスタッツを反映しました。`;
                feedbackDiv.style.color = 'green';
            })
            .catch(error => {
                feedbackDiv.textContent = `通信エラーが発生しました: ${error}`;
                feedbackDiv.style.color = 'red';
            });
        });
    }
  }
});
</script>
{% endblock %}