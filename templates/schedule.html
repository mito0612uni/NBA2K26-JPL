{% extends "layout.html" %}
{% block content %}
<style>
  /* ページ全体のコンテナ */
  .schedule-container {
    max-width: 900px;
    margin: 0 auto;
  }

  /* ページヘッダー（タイトルとボタン） */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap; /* スマホ表示でも改行されるように */
    gap: 15px;
    margin-bottom: 25px;
  }
  .page-header h2 {
    margin: 0;
  }
  .header-actions {
    display: flex;
    gap: 10px;
  }
  .header-actions .button {
    text-decoration: none;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    font-size: 14px;
    border: none;
    cursor: pointer;
  }
  .button.primary { background-color: #007bff; }
  .button.warning { background-color: #ffc107; color: black; }
  .button.danger { background-color: #dc3545; }

  /* 絞り込みフォーム */
  .filter-form {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 25px;
    /* ★★★ フォームを横並びにするために変更 ★★★ */
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: center;
  }
  .filter-form select {
    padding: 5px 8px;
    border-radius: 4px;
    border: 1px solid #ddd;
  }

  /* 試合カード */
  .game-card {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    overflow: hidden; /* カードのデザインを保つ */
  }

  /* カード上部 (日付とパスワード) */
  .game-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #f9f9f9;
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
  }
  .game-date { font-weight: bold; }
  .game-password { font-weight: bold; color: #dc3545; }

  /* カード中央 (試合情報) */
  .game-card-body {
    display: flex;
    align-items: center;
    padding: 20px 15px;
    gap: 10px;
  }
  
  .team-info {
    flex: 1; /* スペースを均等に分ける */
    display: flex;
    align-items: center;
  }
  .team-info.home { justify-content: flex-end; /* 右寄せ */ }
  .team-info.away { justify-content: flex-start; /* 左寄せ */ }
  
  .team-info img {
    height: 25px;
    width: 25px;
    object-fit: contain; /* ロゴの比率を保つ */
  }
  .team-info.home img { margin-right: 10px; }
  .team-info.away img { margin-left: 10px; }
  
  .team-name { font-size: 1.1em; font-weight: bold; }
  .team-label { font-size: 0.8em; color: #777; }

  .score-info {
    flex: 0 0 160px; /* スコア部分は固定幅 */
    text-align: center;
    font-size: 1.4em;
    font-weight: bold;
  }
  /* スコア・不戦勝のスタイル */
  .forfeit-win { color: #dc3545; }
  .forfeit-lose { color: #333; font-style: italic; font-weight: normal; }
  .score-winner { color: #dc3545; }
  .score-loser { color: #555; }
  .vs-text { color: #888; font-size: 1.1em; }


  /* カード下部 (ボタン) */
  .game-card-footer {
    display: flex;
    justify-content: flex-end; /* ボタンを右寄せ */
    align-items: center;
    gap: 15px;
    background-color: #f9f9f9;
    padding: 10px 15px;
    border-top: 1px solid #eee;
    font-size: 14px;
  }
  .game-card-footer a, .game-card-footer button {
    text-decoration: none;
    color: #007bff;
    font-weight: bold;
  }
  .game-card-footer button.delete-btn {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 0;
    font-size: 14px;
    font-weight: bold;
  }

  /* スマホ表示の調整 */
  @media (max-width: 600px) {
    .game-card-body {
      flex-direction: column; /* 縦並びにする */
      gap: 15px;
    }
    .team-info.home { justify-content: center; }
    .team-info.away { justify-content: center; }
    .score-info {
      flex-basis: auto; /* 幅を自動に */
      /* アウェイチームを先に表示（vsの順序のため） */
      order: 1;
    }
    .team-info.home { order: 0; }
    .team-info.away { order: 2; }
    
    .game-card-footer {
      flex-direction: column;
      align-items: stretch; /* ボタンを全幅に */
      gap: 10px;
    }
    .game-card-footer a, .game-card-footer button.delete-btn {
      text-align: center;
      padding: 8px;
      border-radius: 4px;
    }
    .game-card-footer a { background-color: #e9ecef; }
  }

</style>

<div class="schedule-container">
  
  <div class="page-header">
    <h2>試合日程・結果</h2>
    {% if current_user.is_authenticated and current_user.is_admin %}
      <div class="header-actions">
        <a href="{{ url_for('auto_schedule') }}" class="button warning">自動作成</a>
        <a href="{{ url_for('add_schedule') }}" class="button primary">新しい日程を追加</a>
        <form action="{{ url_for('delete_all_schedules') }}" method="post" onsubmit="return confirm('警告：本当に全ての日程と試合結果を削除しますか？この操作は元に戻せません。');" style="margin: 0;">
          <button type="submit" class="button danger">全日程を削除</button>
        </form>
      </div>
    {% endif %}
  </div>

  <form method="get" action="{{ url_for('schedule') }}" class="filter-form">
    
    <div>
      <label for="team-select">チームで絞り込み:</label>
      <select name="team_id" id="team-select" onchange="this.form.submit()">
        <option value="">全チーム</option>
        {% for team in all_teams %}
          <option value="{{ team.id }}" {% if team.id == selected_team_id %}selected{% endif %}>{{ team.name }}</option>
        {% endfor %}
      </select>
    </div>
    
    <div>
      <label for="date-sort">日付で並び替え:</label>
      <select name="sort_order" id="date-sort" onchange="this.form.submit()">
        <option value="asc" {% if selected_sort_order == 'asc' %}selected{% endif %}>昇順 (古い順)</option>
        <option value="desc" {% if selected_sort_order == 'desc' %}selected{% endif %}>降順 (新しい順)</option>
      </select>
    </div>
    </form>
  {% if games %}
    {% for game in games %}
    <div class="game-card">
      <div class="game-card-header">
        <div class="game-date">
          {{ game.game_date }} 
          {% if game.start_time %}{{ game.start_time }}{% endif %}
        </div>
        {% if game.game_password %}
          <div class="game-password">
            パスワード: {{ game.game_password }}
          </div>
        {% endif %}
      </div>
      
      <div class="game-card-body">
        
        <div class="team-info home">
          {% if game.home_team.logo_image %}<img src="{{ game.home_team.logo_image }}" alt="">{% endif %}
          <span class="team-name">{{ game.home_team.name }} <span class="team-label">(Home)</span></span>
        </div>

        <div class="score-info">
          {% if game.is_finished %}
            {% if game.winner_id is not none %}
              {% if game.winner_id == game.home_team.id %}
                <span class="forfeit-win">(不戦勝)</span> - <span class="forfeit-lose">(不戦敗)</span>
              {% else %}
                <span class="forfeit-lose">(不戦敗)</span> - <span class="forfeit-win">(不戦勝)</span>
              {% endif %}
            {% else %}
              {% if game.home_score > game.away_score %}
                <span class="score-winner">{{ game.home_score }}</span> - <span class="score-loser">{{ game.away_score }}</span>
              {% elif game.away_score > game.home_score %}
                <span class="score-loser">{{ game.home_score }}</span> - <span class="score-winner">{{ game.away_score }}</span>
              {% else %}
                <span>{{ game.home_score }}</span> - <span>{{ game.away_score }}</span>
              {% endif %}
            {% endif %}
          {% else %}
            <span class="vs-text">vs</span>
          {% endif %}
        </div>

        <div class="team-info away">
          <span class="team-name"><span class="team-label">(Away)</span> {{ game.away_team.name }}</span>
          {% if game.away_team.logo_image %}<img src="{{ game.away_team.logo_image }}" alt="">{% endif %}
        </div>
      </div>

      <div class="game-card-footer">
        {% if game.youtube_url_home %}<a href="{{ game.youtube_url_home }}" target="_blank" title="{{ game.home_team.name }}視点">[動画 H]</a>{% endif %}
        {% if game.youtube_url_away %}<a href="{{ game.youtube_url_away }}" target="_blank" title="{{ game.away_team.name }}視点">[動画 A]</a>{% endif %}
        
        <a href="{{ url_for('edit_game', game_id=game.id) }}">
          {% if game.is_finished %}編集/閲覧{% else %}結果入力{% endif %}
        </a>
        
        {% if current_user.is_authenticated and current_user.is_admin %}
          <form action="{{ url_for('delete_game', game_id=game.id) }}" method="post" onsubmit="return confirm('本当にこの日程を削除しますか？');" style="display: inline; margin: 0;">
            <button type="submit" class="delete-btn">[削除]</button>
          </form>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  {% else %}
    <p>該当する試合はありません。</p>
  {% endif %}
</div>
{% endblock %}